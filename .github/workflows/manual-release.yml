name: Manual Release

on:
  workflow_dispatch:
    inputs:
      release_mode:
        description: 'Release mode'
        required: true
        type: choice
        default: 'instant'
        options:
          - instant
          - changeset-pr
      bump_type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      description:
        description: 'Release description (optional)'
        required: false
        type: string

jobs:
  # Instant release - commits directly to main and publishes
  instant-release:
    name: Instant Release
    if: github.event.inputs.release_mode == 'instant'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm install

      - name: Upgrade npm for OIDC trusted publishing support
        run: npm install -g npm@latest

      - name: Version packages and commit to main
        id: version
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Get current version before bump
          OLD_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $OLD_VERSION"

          # Run instant version bump script
          if [ -n "${{ github.event.inputs.description }}" ]; then
            node scripts/instant-version-bump.mjs "${{ github.event.inputs.bump_type }}" "${{ github.event.inputs.description }}"
          else
            node scripts/instant-version-bump.mjs "${{ github.event.inputs.bump_type }}"
          fi

          # Get new version after bump
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # Check if there are changes to commit
          if [[ -n $(git status --porcelain) ]]; then
            echo "Changes detected, committing..."

            # Stage all changes (package.json, package-lock.json, CHANGELOG.md)
            git add -A

            # Build commit message
            COMMIT_MSG="$NEW_VERSION"$'\n'$'\n'"Manual ${{ github.event.inputs.bump_type }} release"$'\n'$'\n'"ü§ñ Generated with [Claude Code](https://claude.com/claude-code)"

            # Commit with version number as message
            git commit -m "$COMMIT_MSG"

            # Push directly to main
            git push origin main

            echo "‚úÖ Version bump committed and pushed to main"
            echo "version_committed=true" >> $GITHUB_OUTPUT
          else
            echo "No changes to commit"
            echo "version_committed=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish to npm
        if: steps.version.outputs.version_committed == 'true'
        id: publish
        run: |
          # Publish to npm using OIDC trusted publishing
          # Note: Provenance is automatically generated when using OIDC (id-token: write)
          npm run changeset:publish

          echo "published=true" >> $GITHUB_OUTPUT

          # Get published version
          PUBLISHED_VERSION=$(node -p "require('./package.json').version")
          echo "published_version=$PUBLISHED_VERSION" >> $GITHUB_OUTPUT
          echo "‚úÖ Published lino-arguments@$PUBLISHED_VERSION to npm"

      - name: Create GitHub Release
        if: steps.publish.outputs.published == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.publish.outputs.published_version }}"
          TAG="v$VERSION"

          echo "Creating GitHub release for $TAG..."

          # Extract changelog entry for this version
          # Read from CHANGELOG.md between this version header and the next version header
          RELEASE_NOTES=$(awk "/## $VERSION/{flag=1; next} /## [0-9]/{flag=0} flag" CHANGELOG.md)

          if [ -z "$RELEASE_NOTES" ]; then
            RELEASE_NOTES="Release $VERSION"
          fi

          # Create release
          gh release create "$TAG" \
            --title "$VERSION" \
            --notes "$RELEASE_NOTES" \
            --repo ${{ github.repository }}

          echo "‚úÖ Created GitHub release: $TAG"

      - name: Format GitHub release notes
        if: steps.publish.outputs.published == 'true'
        run: |
          VERSION="${{ steps.publish.outputs.published_version }}"
          TAG="v$VERSION"

          # Get the release ID for this version
          RELEASE_ID=$(gh api repos/${{ github.repository }}/releases/tags/$TAG --jq '.id' 2>/dev/null || echo "")

          if [ -n "$RELEASE_ID" ]; then
            echo "Formatting release notes for $TAG..."
            node scripts/format-release-notes.mjs "$RELEASE_ID" "$TAG" "${{ github.repository }}"
            echo "‚úÖ Formatted release notes for $TAG"
          else
            echo "‚ö†Ô∏è Could not find release for $TAG"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Changeset PR - creates a pull request with the changeset for review
  changeset-pr:
    name: Create Changeset PR
    if: github.event.inputs.release_mode == 'changeset-pr'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm install

      - name: Create changeset file
        run: |
          # Get description from workflow input or use default
          DESCRIPTION="${{ github.event.inputs.description }}"

          # Run the create-manual-changeset script
          if [ -n "$DESCRIPTION" ]; then
            node scripts/create-manual-changeset.mjs "${{ github.event.inputs.bump_type }}" "$DESCRIPTION"
          else
            node scripts/create-manual-changeset.mjs "${{ github.event.inputs.bump_type }}"
          fi

      - name: Format changeset with Prettier
        run: |
          # Run Prettier on the changeset file to ensure it matches project style
          npx prettier --write ".changeset/*.md" || true

          echo "Formatted changeset files"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: add changeset for manual ${{ github.event.inputs.bump_type }} release'
          branch: changeset-manual-release-${{ github.run_id }}
          delete-branch: true
          title: 'chore: manual ${{ github.event.inputs.bump_type }} release'
          body: |
            ## Manual Release Request

            This PR was created by a manual workflow trigger to prepare a **${{ github.event.inputs.bump_type }}** release.

            ### Release Details
            - **Type:** ${{ github.event.inputs.bump_type }}
            - **Description:** ${{ github.event.inputs.description || 'Manual release' }}
            - **Triggered by:** @${{ github.actor }}

            ### Next Steps
            1. Review the changeset in this PR
            2. Merge this PR to main
            3. The automated release workflow will version the package and publish to npm using OIDC trusted publishing

            ---

            ü§ñ Generated with [Claude Code](https://claude.com/claude-code)
