# Issue #10: Comprehensive Analysis - Trusted Publishing Failures

## Executive Summary

This document provides a comprehensive analysis of Issue #10: "Trusted publishing does not work in our CI/CD", covering multiple failure scenarios, their root causes, and resolutions.

**Status**: âœ… **RESOLVED**
- **Original E422 Error**: Fixed in PR #11
- **npm Package**: Successfully published version 0.2.5 with provenance
- **Verification**: Package available at https://www.npmjs.com/package/lino-arguments

## Issue Timeline

| Date | Event | Status | Details |
|------|-------|--------|---------|
| 2025-12-09 06:27 | CI Run #20054176340 | âŒ Failed | E422 Error: Missing repository field |
| 2025-12-09 06:57 | CI Run #20054779258 (PR #11 merged) | âœ… Success | Published v0.2.5 successfully |
| 2025-12-09 07:03 | Manual Release #20054899930 | âŒ Failed | E404 Error: Different issue (authentication) |

## Part 1: The E422 Error (RESOLVED âœ…)

### Symptoms

```
ğŸ¦‹  error an error occurred while publishing lino-arguments:
E422 422 Unprocessable Entity - PUT https://registry.npmjs.org/lino-arguments -
Error verifying sigstore provenance bundle: Failed to validate repository information:
package.json: "repository.url" is "", expected to match
"https://github.com/link-foundation/lino-arguments" from provenance
```

### Root Cause

npm's trusted publishing feature performs server-side validation to ensure the `repository.url` field in `package.json` matches the Source Repository URI extension in the signing certificate generated by GitHub Actions OIDC.

**The problem**: `package.json` was missing the `repository` field entirely.

### How npm Trusted Publishing Works

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GitHub Actions  â”‚
â”‚   Workflow      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 1. Request OIDC token
         â”‚    with repo metadata
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   GitHub OIDC   â”‚
â”‚   Provider      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 2. Generate JWT with claims:
         â”‚    - repository: link-foundation/lino-arguments
         â”‚    - workflow: .github/workflows/main.yml
         â”‚    - ref: refs/heads/main
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  npm Registry   â”‚
â”‚   (with OIDC)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 3. Validate provenance:
         â”‚    - Check package.json repository.url
         â”‚    - Match against JWT claims
         â”‚    - Verify Sigstore signature
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Sigstore     â”‚
â”‚ Transparency Logâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Validation Requirements

For npm provenance to work with OIDC trusted publishing:

1. âœ… `id-token: write` permission in workflow
2. âœ… npm CLI version supporting OIDC (v9.0.0+)
3. âŒ **`repository` field in package.json** (was missing)
4. âœ… Trusted publisher configured on npmjs.com
5. âœ… Publishing from a public repository

### The Fix (PR #11)

Added the `repository` field to `package.json`:

```json
{
  "repository": {
    "type": "git",
    "url": "https://github.com/link-foundation/lino-arguments.git"
  }
}
```

### Verification

After PR #11 was merged:
- âœ… CI Run #20054779258 succeeded
- âœ… Published lino-arguments@0.2.5 to npm
- âœ… Provenance attestation created and verified
- âœ… Package visible at https://www.npmjs.com/package/lino-arguments

```bash
$ npm view lino-arguments versions --json
[
  "0.2.1",
  "0.2.5"
]
```

## Part 2: The E404 Error (Manual Release Workflow)

### Symptoms

```
ğŸ¦‹  error an error occurred while publishing lino-arguments:
E404 Not Found - PUT https://registry.npmjs.org/lino-arguments - Not found
The requested resource 'lino-arguments@0.2.6' could not be found or you do not have permission to access it.

npm notice Access token expired or revoked. Please try logging in again.
```

### Root Cause

The manual release workflow (`manual-release.yml`) attempts to use trusted publishing but encounters authentication issues. The workflow has:

- âœ… `id-token: write` permission
- âœ… `registry-url` configuration
- âŒ **No authentication fallback or proper OIDC setup for manual workflows**

### Key Difference vs Automated Workflow

| Aspect | main.yml (Automated) | manual-release.yml (Manual) |
|--------|---------------------|----------------------------|
| Trigger | `push` to main | `workflow_dispatch` |
| Authentication | OIDC trusted publishing | Same attempt, but fails |
| npm upgrade | Yes (line 164-165) | Yes (line 51-52) |
| Success Rate | âœ… Working | âŒ Failing with E404 |

### Analysis: Why Manual Release Fails

The E404 error with "Access token expired or revoked" message suggests:

1. **OIDC token generation may work differently for `workflow_dispatch`** events vs `push` events
2. The workflow tries to use OIDC but npm sees it as unauthenticated
3. npm returns E404 instead of E403 to avoid leaking package existence info

### Comparison with test-anywhere Repository

The `test-anywhere` repository uses a **hybrid approach**:

```yaml
# test-anywhere common.yml (lines 160-161)
env:
  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
  NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
```

**Key insight**: test-anywhere uses traditional NPM_TOKEN authentication, NOT trusted publishing with OIDC.

## Part 3: Authentication Strategies Comparison

### Strategy 1: NPM_TOKEN (Traditional)

**Used by**: test-anywhere

**Pros**:
- âœ… Works reliably for all workflow types
- âœ… Simple to set up
- âœ… Consistent behavior

**Cons**:
- âŒ Requires managing long-lived tokens
- âŒ Token rotation needed
- âŒ No automatic provenance

### Strategy 2: OIDC Trusted Publishing (Modern)

**Used by**: lino-arguments

**Pros**:
- âœ… No long-lived tokens to manage
- âœ… Automatic provenance attestation
- âœ… More secure (short-lived tokens)
- âœ… Recommended by npm

**Cons**:
- âŒ Requires configuration on npmjs.com
- âŒ Only works for specific workflow triggers
- âŒ May have edge cases (like manual workflows)

## Part 4: Current Configuration Status

### npm Package Settings (from issue screenshot)

| Setting | Value | Status |
|---------|-------|--------|
| Package Name | lino-arguments | âœ… |
| Latest Version | 0.2.5 | âœ… Published |
| Access | Public | âœ… |
| Trusted Publisher | link-foundation/lino-arguments | âœ… Configured |
| Workflow | main.yml | âœ… |

### GitHub Workflow Configuration

```yaml
# .github/workflows/main.yml
release:
  permissions:
    contents: write
    pull-requests: write
    id-token: write  # â† Enables OIDC
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        registry-url: 'https://registry.npmjs.org'

    - name: Upgrade npm for OIDC trusted publishing support
      run: npm install -g npm@latest

    - name: Publish to npm
      run: npm run changeset:publish
      # No NODE_AUTH_TOKEN needed - uses OIDC
```

## Part 5: Lessons Learned

### 1. Always Include Repository Metadata

**Lesson**: Even if not explicitly required by npm documentation, the `repository` field is mandatory for provenance validation.

**Action**: Add to all packages:
```json
{
  "repository": {
    "type": "git",
    "url": "https://github.com/org/repo.git"
  }
}
```

### 2. OIDC Has Context Limitations

**Lesson**: Trusted publishing with OIDC may not work identically for all workflow trigger types.

**Action**: For workflows that need guaranteed publishing (like manual releases):
- Option A: Use NPM_TOKEN as fallback
- Option B: Trigger automated workflow instead of direct publish
- Option C: Further investigate OIDC configuration for manual workflows

### 3. Error Messages Can Be Misleading

**Lesson**: E404 "Not found" may actually mean "Not authenticated" for security reasons.

**Action**: Always check:
- npm authentication logs ("Access token expired or revoked")
- Workflow permissions
- OIDC token generation steps

### 4. Test Both Automated and Manual Flows

**Lesson**: Just because automated publishing works doesn't mean manual workflows will work identically.

**Action**: Test all workflow paths before considering a CI/CD pipeline production-ready.

## Part 6: Recommendations

### For lino-arguments (Current Repository)

#### Short-term (Original Issue - DONE âœ…)
- âœ… Repository field added
- âœ… Automated releases working
- âœ… Package published successfully

#### Medium-term (Manual Release Improvement)
Consider one of these approaches:

**Option A**: Add NPM_TOKEN fallback for manual workflows
```yaml
- name: Publish to npm
  env:
    NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
  run: npm run changeset:publish
```

**Option B**: Use common.yml pattern like test-anywhere
- Extract common release logic
- Pass NPM_TOKEN or rely on OIDC based on context
- Maintain consistency across workflows

**Option C**: Document manual release limitations
- Use changeset-pr mode for manual releases
- Let automated workflow handle the actual publishing
- Keep trusted publishing for main branch only

### For Organization-wide Standards

1. **Create a shared workflows repository** with reusable release workflows
2. **Document the trusted publishing setup** for new repositories
3. **Establish guidelines** on when to use OIDC vs NPM_TOKEN
4. **Create a checklist** for enabling trusted publishing:
   - [ ] Repository field in package.json
   - [ ] Trusted publisher configured on npmjs.com
   - [ ] id-token: write permission in workflow
   - [ ] npm upgraded to latest in CI
   - [ ] Tested with actual publish (not dry-run)

## Part 7: Related Issues and References

### npm Documentation
- [Trusted Publishers](https://docs.npmjs.com/trusted-publishers/)
- [Generating Provenance Statements](https://docs.npmjs.com/generating-provenance-statements/)
- [Configuring npm for use with GitHub Actions](https://docs.github.com/en/actions/publishing-packages/publishing-nodejs-packages)

### Known Issues
- [npm/cli#8036](https://github.com/npm/cli/issues/8036) - Capitalization mismatch in repository URLs
- [npm/provenance](https://github.com/npm/provenance) - npm provenance repository
- [GitHub Blog: npm trusted publishing with OIDC](https://github.blog/changelog/2025-07-31-npm-trusted-publishing-with-oidc-is-generally-available/)

### Sigstore Verification
- Published provenance for v0.2.5: https://search.sigstore.dev/?logIndex=752580455

## Part 8: Files and Data

### CI Logs Downloaded
- `ci-logs/run-20054176340.txt` - Initial E422 failure
- `ci-logs/successful-run-20054779258.log` - Successful publish of 0.2.5
- `ci-logs/latest-failure-20054899930.log` - Manual release E404 failure
- `ci-runs-list.json` - List of all CI runs

### Reference Materials
- `reference-workflows/test-anywhere-common.yml` - test-anywhere common workflow
- `reference-workflows/test-anywhere-manual-release.yml` - test-anywhere manual release

### Analysis Documents
- `docs/case-studies/trusted-publishing-failure-case-study.md` - Original E422 analysis
- `experiments/ROOT_CAUSE_ANALYSIS.md` - Initial root cause analysis
- `docs/case-studies/issue-10-comprehensive-analysis.md` - This document

## Conclusion

**Issue #10 is RESOLVED âœ…**

The original problem (E422 error preventing trusted publishing) has been successfully fixed by adding the `repository` field to `package.json`. The automated CI/CD pipeline now works correctly:

- âœ… Tests pass on Node.js, Bun, and Deno
- âœ… Lint and format checks pass
- âœ… Version bump commits to main automatically
- âœ… npm publish succeeds with provenance attestation
- âœ… GitHub releases created automatically

**Additional finding**: The manual release workflow has a separate E404 authentication issue, which is distinct from the original trusted publishing problem. This is a lower-priority enhancement that can be addressed separately if manual instant releases are needed.

**Recommendation**: Close Issue #10 as resolved. The core trusted publishing functionality is working. If manual release functionality is needed, create a new issue specifically for that enhancement.

---

*Analysis completed: 2025-12-09*
*Primary issue resolution: PR #11*
*Package successfully published: lino-arguments@0.2.5*
