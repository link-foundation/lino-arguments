{
  "author": {
    "id": "MDQ6VXNlcjE0MzE5MDQ=",
    "is_bot": false,
    "login": "konard",
    "name": "Konstantin Diachenko"
  },
  "body": "## Summary\n\nThe `makeConfig` function fails to parse custom `--version` options because yargs' built-in `--version` flag overrides user-defined options. This causes CLI arguments to return `false` instead of the provided value.\n\n## Environment\n\n- **lino-arguments version**: latest (from unpkg)\n- **Node.js version**: v20.19.6\n- **Platform**: Linux, macOS, GitHub Actions (CI)\n\n## Minimal Reproduction\n\n```javascript\n#!/usr/bin/env node\n\n// Load use-m dynamically\nconst { use } = eval(\n  await (await fetch('https://unpkg.com/use-m/use.js')).text()\n);\n\n// Import lino-arguments\nconst { makeConfig } = await use('lino-arguments');\n\nconsole.log('process.argv:', process.argv);\n\n// Parse CLI arguments using lino-arguments\nconst config = makeConfig({\n  yargs: ({ yargs, getenv }) =>\n    yargs.option('version', {\n      type: 'string',\n      default: getenv('VERSION', ''),\n      describe: 'Version number (e.g., 1.0.0)',\n    }),\n});\n\nconsole.log('config.version:', JSON.stringify(config.version));\n\nif (config.version === false) {\n  console.error('❌ BUG: --version returned false instead of the value');\n  process.exit(1);\n} else {\n  console.log('✅ --version parsed correctly:', config.version);\n}\n```\n\n**Run the reproduction:**\n\n```bash\nnode minimal-repro.mjs --version \"1.0.0\"\n```\n\n**Expected Output:**\n\n```\nprocess.argv: [ '/usr/bin/node', '/path/to/minimal-repro.mjs', '--version', '1.0.0' ]\nconfig.version: \"1.0.0\"\n✅ --version parsed correctly: 1.0.0\n```\n\n**Actual Output:**\n\n```\nprocess.argv: [ '/usr/bin/node', '/path/to/minimal-repro.mjs', '--version', '1.0.0' ]\nconfig.version: false\n❌ BUG: --version returned false instead of the value\n```\n\n## Root Cause\n\nIn `src/index.js`, the `makeConfig` function creates two yargs instances:\n\n1. **Initial parse** (lines 337-345): Disables built-in help/version with `.help(false)` and `.version(false)`\n2. **Final parse** (lines 360-373): Does NOT disable built-in help/version ⚠️\n\nThe second yargs instance (which produces the final result) has yargs' built-in `--version` flag enabled, which conflicts with custom `--version` options.\n\n**Relevant code (src/index.js:360-373):**\n\n```javascript\n// Step 5: Configure yargs with user options + getenv helper\nconst yargsInstance = yargs(hideBin(argv)).option('configuration', {\n  type: 'string',\n  describe: 'Path to configuration .lenv file',\n  alias: 'c',\n});\n// ⬆️ Missing .version(false) here (it was present in initial parse at line 344)\n\n// Pass getenv helper if enabled\nconst getenvHelper = getenvEnabled ? getenv : () => '';\nconst configuredYargs = yargsConfigFn\n  ? yargsConfigFn({ yargs: yargsInstance, getenv: getenvHelper })\n  : yargsInstance;\n\n// Step 6: Parse final configuration (CLI args have highest priority)\nconst parsed = configuredYargs.parseSync();\n```\n\n## Impact\n\nThis bug affects any script using `lino-arguments` with a custom `--version` option:\n\n- ❌ Release scripts fail in CI (like GitHub Actions)\n- ❌ CLI tools can't accept version arguments\n- ❌ Scripts silently get wrong values (`false` instead of user input)\n\n**Real-world example:** In the [test-anywhere](https://github.com/link-foundation/test-anywhere) repository, release scripts failed because `makeConfig` returned `version: false` instead of `\"0.8.34\"` (see issues [#116](https://github.com/link-foundation/test-anywhere/issues/116) and [#118](https://github.com/link-foundation/test-anywhere/issues/118)).\n\n## Proposed Fix\n\nAdd `.version(false)` to the final yargs instance to match the initial parse:\n\n```diff\n  // Step 5: Configure yargs with user options + getenv helper\n  const yargsInstance = yargs(hideBin(argv))\n+   .version(false)  // Disable built-in version to allow custom --version option\n    .option('configuration', {\n      type: 'string',\n      describe: 'Path to configuration .lenv file',\n      alias: 'c',\n    });\n```\n\n**Why this fix works:**\n\n1. ✅ Consistency: Both initial and final parse behave the same way\n2. ✅ User control: Users can define their own `--version` and `--help` options if needed\n3. ✅ Backwards compatible: Doesn't break existing code\n4. ✅ Simple: No complex detection logic required\n\n**Optional:** Also add `.help(false)` to prevent the same issue with `--help`:\n\n```diff\n  const yargsInstance = yargs(hideBin(argv))\n+   .help(false)     // Disable built-in help to allow custom --help option\n+   .version(false)  // Disable built-in version to allow custom --version option\n    .option('configuration', {\n```\n\n## Workaround\n\nUntil this is fixed, avoid using `--version` and `--help` as option names. Use alternatives like `--ver`, `--release-version`, etc.\n\n## Test Case\n\nAfter applying the fix, this test should pass:\n\n```javascript\nimport { makeConfig } from 'lino-arguments';\nimport assert from 'assert';\n\nconst config = makeConfig({\n  argv: ['node', 'test.mjs', '--version', '1.0.0'],\n  yargs: ({ yargs }) =>\n    yargs.option('version', { type: 'string', default: '' }),\n});\n\nassert.strictEqual(config.version, '1.0.0');\nconsole.log('✅ Test passed');\n```\n",
  "comments": [
    {
      "id": "IC_kwDOQNj-9c7ZBMtQ",
      "author": { "login": "konard" },
      "authorAssociation": "MEMBER",
      "body": "We need to make sure we have tests that actually reproduce these issues, and also test workarounds.\n\nPlease download all logs and data related about the issue to this repository, make sure we compile that data to `./docs/case-studies/issue-{id}` folder, and use it to do deep case study analysis (also make sure to search online for additional facts and data), in which we will reconstruct timeline/sequence of events, find root causes of the problem, and propose possible solutions.",
      "createdAt": "2025-12-11T09:12:10Z",
      "includesCreatedEdit": false,
      "isMinimized": false,
      "minimizedReason": "",
      "reactionGroups": [],
      "url": "https://github.com/link-foundation/lino-arguments/issues/13#issuecomment-3640970064",
      "viewerDidAuthor": true
    }
  ],
  "createdAt": "2025-12-11T00:44:51Z",
  "labels": [],
  "state": "OPEN",
  "title": "Bug: --version flag conflicts with custom options in makeConfig",
  "updatedAt": "2025-12-11T09:12:10Z"
}
